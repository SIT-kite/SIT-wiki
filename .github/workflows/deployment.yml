# This workflow will install Python dependencies, build wiki pages and deploy.
# For more information see:
# https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Publish Wiki

on:
  push:         { branches: [ master ] }
  pull_request: { branches: [ master ] }

jobs:

  build:
    runs-on: ubuntu-latest
    strategy: { matrix: { python-version: [ "3.10" ] } }

    steps:

    - uses: actions/checkout@v2

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip

    - name: Install requirements
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install mkdocs-material
        python3 -m pip install markdown-cjk-spacing
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Build wiki
      run: mkdocs build

    - name: Copy file via SSH
      uses: appleboy/scp-action@v0.1.2
      with:
        host:     ${{ secrets.SERVER_HOST }}
        port:     ${{ secrets.PORT }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_SECRET }}
        source: "./site/*"
        target: "/var/kite/SIT-wiki/site/"
        strip_components: 1

  notification:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:

      - uses: technote-space/workflow-conclusion-action@v2

      - uses: benjlevesque/short-sha@v1.2
        id: short-sha
        with: { length: 7 }

      - name: ðŸŽ¯ Telegram Notification
        if: env.WORKFLOW_CONCLUSION == 'success'
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.CHAT_ID }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ðŸŽ‰ [Wiki](https://github.com/SIT-kite/SIT-wiki)  Build  *${{ env.WORKFLOW_CONCLUSION }}*

            Author: *${{ github.actor }}*

            Message: *${{ github.event.head_commit.message }}*

            Commit: [${{ env.SHA }}](https://github.com/${{ github.repository }}/commit/${{ env.SHA }})

      - name: ðŸŽ¯ Telegram Notification
        if: env.WORKFLOW_CONCLUSION != 'success'
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.CHAT_ID }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ðŸ”´ [Wiki](https://github.com/SIT-kite/SIT-wiki)  Build  *${{ env.WORKFLOW_CONCLUSION }}*

            Author: *${{ github.actor }}*

            Message: *${{ github.event.head_commit.message }}*

            Commit: [${{ env.SHA }}](https://github.com/${{ github.repository }}/commit/${{ env.SHA }})
